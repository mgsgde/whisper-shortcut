name: Build and Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build, Sign, Notarize, and Release
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Import signing certificate
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD || 'temporary-keychain-password' }}
        run: |
          # Create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # Decode certificate
          echo "$BUILD_CERTIFICATE_BASE64" | base64 --decode > $CERTIFICATE_PATH

          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate to keychain
          security import $CERTIFICATE_PATH -k $KEYCHAIN_PATH -P "$P12_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Make keychain default for codesign
          security default-keychain -s $KEYCHAIN_PATH

          # Find and store the certificate identity for later use
          IDENTITY=$(security find-identity -v -p codesigning "$KEYCHAIN_PATH" | grep "Developer ID Application" | head -1 | sed 's/.*"\(.*\)".*/\1/')
          if [ -z "$IDENTITY" ]; then
            echo "❌ Error: Developer ID Application certificate not found after import"
            security find-identity -v -p codesigning "$KEYCHAIN_PATH"
            exit 1
          fi
          echo "CERT_IDENTITY=$IDENTITY" >> $GITHUB_ENV
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV
          echo "Found certificate identity: $IDENTITY"

      - name: Build and archive
        run: |
          xcodebuild clean archive \
            -project WhisperShortcut.xcodeproj \
            -scheme WhisperShortcut \
            -configuration Release \
            -archivePath $RUNNER_TEMP/WhisperShortcut.xcarchive \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Developer ID Application" \
            DEVELOPMENT_TEAM=${{ secrets.TEAM_ID }} \
            PROVISIONING_PROFILE_SPECIFIER=""

      - name: Export archive
        run: |
          xcodebuild -exportArchive \
            -archivePath $RUNNER_TEMP/WhisperShortcut.xcarchive \
            -exportPath $RUNNER_TEMP/export \
            -exportOptionsPlist exportOptions-release.plist

      - name: Create DMG
        run: |
          APP_PATH="$RUNNER_TEMP/export/WhisperShortcut.app"
          DMG_PATH="$RUNNER_TEMP/WhisperShortcut.dmg"
          VOLUME_NAME="WhisperShortcut"

          # Create a temporary directory for DMG contents
          DMG_TEMP="$RUNNER_TEMP/dmg_temp"
          mkdir -p "$DMG_TEMP"

          # Copy app to DMG directory
          cp -R "$APP_PATH" "$DMG_TEMP/"

          # Create a link to Applications directory
          ln -s /Applications "$DMG_TEMP/Applications"

          # Create DMG
          hdiutil create -volname "$VOLUME_NAME" \
            -srcfolder "$DMG_TEMP" \
            -ov -format UDZO \
            "$DMG_PATH"

          echo "DMG_PATH=$DMG_PATH" >> $GITHUB_ENV

      - name: Sign DMG
        run: |
          # Unlock the keychain (needed for codesign)
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Sign the DMG with the imported certificate identity
          codesign --force --verify --verbose --sign "$CERT_IDENTITY" --keychain "$KEYCHAIN_PATH" "$DMG_PATH"

          # Verify DMG signature
          codesign --verify --verbose "$DMG_PATH" || {
            echo "❌ Error: DMG signature verification failed"
            codesign -dvv "$DMG_PATH"
            exit 1
          }

          echo "✅ DMG signed successfully"

      - name: Notarize app
        env:
          NOTARY_USERNAME: ${{ secrets.NOTARY_USERNAME }}
          NOTARY_PASSWORD: ${{ secrets.NOTARY_PASSWORD }}
          TEAM_ID: ${{ secrets.TEAM_ID }}
        run: |
          # Notarize the DMG
          xcrun notarytool submit "$DMG_PATH" \
            --apple-id "$NOTARY_USERNAME" \
            --password "$NOTARY_PASSWORD" \
            --team-id "$TEAM_ID" \
            --wait

      - name: Staple notarization ticket
        run: |
          xcrun stapler staple "$DMG_PATH"

      - name: Verify notarization
        run: |
          # Verify stapling
          xcrun stapler validate "$DMG_PATH"

          # Verify code signature
          codesign --verify --verbose "$DMG_PATH"

          # Verify Gatekeeper acceptance
          spctl -a -vvv -t install "$DMG_PATH"

      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.DMG_PATH }}
          name: Release ${{ steps.get_version.outputs.version }}
          body: |
            ## WhisperShortcut ${{ steps.get_version.outputs.version }}

            ### Installation
            1. Download the DMG file
            2. Open the DMG and drag WhisperShortcut to your Applications folder
            3. Open WhisperShortcut from Applications (you may need to allow it in System Settings > Privacy & Security)

            ### Changes
            See the [changelog](https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.sha }}) for details.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup keychain
        if: always()
        run: |
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
