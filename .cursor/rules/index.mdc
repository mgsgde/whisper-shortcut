---
alwaysApply: true
---

## üìã Project Overview

**WhisperShortcut** is a macOS menu bar app for real-time audio transcription and AI voice workflows (Speech-to-Text, Speech-to-Prompt, Read Aloud, Prompt & Read). Xcode project, not SPM.

**Stack**: Swift 5.9+, Cocoa, AVFoundation, UserNotifications ¬∑ **Target**: macOS 15.5+

## üèóÔ∏è Architecture (Summary)

- **State machine**: Single source of truth is `AppState` in `AppState.swift` (`idle`, `recording`, `processing`, `playback`, `feedback`). Always transition via AppState; never manipulate UI or flags directly.
- **Orchestration**: `MenuBarController` owns services and shortcuts; `SpeechService` holds the main logic (transcribe, executePrompt, executePromptWithVoiceResponse).
- **Core services**: AudioRecorder, TTSService, AudioPlaybackService, ClipboardManager, KeychainManager, AudioChunkingService.
- **Patterns**: Use `DebugLogger` only (no `print`/`NSLog`/`os_log`). UI updates on main thread (MainActor). Support cancellation in async work (`Task.checkCancellation()`, cancel methods). Typed errors + `SpeechErrorFormatter` for user messages.

## ‚ö° Critical Rules

- **KISS**: Prefer the simplest, most robust solution.
- **Rebuild after changes**: Run `bash scripts/rebuild-and-restart.sh` after every code change.
- **Logging in code**: Use only `DebugLogger` methods; never `print()`, `NSLog()`, or `os_log()`. For **viewing** logs use skill **view-logs-via-bash**. For **debugging or adding instrumentation** (and full flow: repro plan ‚Üí analyze logs) use skill **debugging-workflow**.
- **Tests**: Do not run tests from the agent; user runs them manually in Xcode.

## üó£Ô∏è Communication

- **Understand first**: Clarify requirements and confirm understanding before implementing.

## üöÄ Run / Rebuild

```bash
bash ./scripts/rebuild-and-restart.sh
```

## üìÅ Data Directories (Sandbox vs Normal)

App data (UserContext, interaction logs) can live in **two** places:
- **Sandbox:** `~/Library/Containers/com.magnusgoedde.whispershortcut/Data/Library/Application Support/WhisperShortcut/`
- **Normal:** `~/Library/Application Support/WhisperShortcut/`

Which one is used depends on whether the app runs sandboxed (e.g. App Store) or not. When debugging, resetting, or counting interaction logs, check **both** or the one that matches how the app is currently run. See `docs/data-directories.md` for details.
