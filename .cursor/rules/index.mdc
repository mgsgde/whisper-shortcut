---
alwaysApply: true
---

## üìã Project Overview

**WhisperShortcut** is a macOS menu bar app for real-time audio transcription and AI voice workflows (Speech-to-Text, Speech-to-Prompt, Read Aloud, Prompt & Read). Xcode project, not SPM.

**Stack**: Swift 5.9+, Cocoa, AVFoundation, UserNotifications ¬∑ **Target**: macOS 15.5+

## üèóÔ∏è Architecture (Summary)

- **State machine**: Single source of truth is `AppState` in `AppState.swift` (`idle`, `recording`, `processing`, `feedback`). Always transition via AppState; never manipulate UI or flags directly.
- **Orchestration**: `MenuBarController` owns services and shortcuts; `SpeechService` holds the main logic (transcribe, executePrompt, executePromptWithVoiceResponse).
- **Core services**: AudioRecorder, TTSService, AudioPlaybackService, ClipboardManager, KeychainManager, AudioChunkingService.
- **Patterns**: Use `DebugLogger` only (no `print`/`NSLog`/`os_log`). UI updates on main thread (MainActor). Support cancellation in async work (`Task.checkCancellation()`, cancel methods). Typed errors + `SpeechErrorFormatter` for user messages.

## ‚ö° Critical Rules

- **KISS**: Prefer the simplest, most robust solution.
- **Rebuild after changes**: After making any code or project changes, the agent must run `bash scripts/rebuild-and-restart.sh` itself (do not only suggest it). Run it once at the end of the edits so the user can test immediately.
- **Logging in code**: Use only `DebugLogger` methods; never `print()`, `NSLog()`, or `os_log()`. For **viewing** logs use skill **view-logs-via-bash**. For **debugging or adding instrumentation** (and full flow: repro plan ‚Üí analyze logs) use skill **debugging-workflow**.
- **Tests**: Do not run tests from the agent; user runs them manually in Xcode.
- **Commands are slash commands only**: In this project, "commands" are always **typed** by the user: a leading slash plus a keyword (e.g. `/stop`, `/new`, `/back`). Do not implement commands as hotkeys or keyboard shortcuts; use slash commands in the chat/input and reserve hotkeys for system shortcuts (e.g. menu bar actions).
- **Language**: All user-facing and in-repository text must be in **English**. This includes: UI strings, confirmation dialogs, button labels, tooltips, section titles, code comments, default prompts and examples in code, and documentation. Do not add or leave German (or other non-English) text in the codebase.

## üó£Ô∏è Communication

- **Understand first**: Clarify requirements and confirm understanding before implementing.

## üöÄ Run / Rebuild

```bash
bash ./scripts/rebuild-and-restart.sh
```

## üîó Gemini API / models

When working with **Gemini models** (transcription, prompt mode, TTS, model IDs, or API issues):  

- Use the official Gemini API documentation: <https://ai.google.dev/gemini-api/docs>  
- Always verify current model IDs using official docs and the **gemini-model-docs** skill.  
- Regularly check the **Google AI Developers Forum** for outages, deprecations, and known issues: <https://discuss.ai.google.dev/c/gemini-api/4>

## üìÅ Data Directories (Sandbox vs Normal)

App data (UserContext, interaction logs) can live in **two** places:

- **Sandbox:** `~/Library/Containers/com.magnusgoedde.whispershortcut/Data/Library/Application Support/WhisperShortcut/`
- **Normal:** `~/Library/Application Support/WhisperShortcut/`

Which one is used depends on whether the app runs sandboxed (e.g. App Store) or not. When debugging, resetting, or counting interaction logs, check **both** or the one that matches how the app is currently run. See `docs/data-directories.md` for details.
